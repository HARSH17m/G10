{% extends 'expense/base.html' %}

{% block title %}EXPENSE TRACKER{% endblock %}
{% block styles %}{% endblock %}
{% block page %}EXPENSE TRACKER{% endblock %}
{% block body %}

{% if is_employed %}
  {% if show_popup %}
    <div class="container mt-4">
      <form method="post">
        {% csrf_token %}
        <div class="card p-3 shadow-sm">
          <h5 class="mb-3">Monthly Salary Input</h5>

          <div class="mb-3">
            <label for="salary" class="form-label">Salary (₹)</label>
            <input type="number" class="form-control" id="salary" name="salary"
                   value="{{ user_salary.salary|default:0 }}"
                   {% if not allow_edit %}readonly{% endif %} required>
            {% if not allow_edit and not is_first_time %}
              <small class="text-muted">Editable again on reset day.</small>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Fixed Expenses</label>
            <table class="table table-bordered" id="fixedExpenseTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Amount (₹)</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="expenseRows">
                {% for key, value in user_salary.fixed_expenses.items %}
                <tr>
                  <td><input type="text" name="item" class="form-control" value="{{ key }}"></td>
                  <td><input type="number" name="amount" class="form-control" value="{{ value }}"></td>
                  <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">✖</button></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow()">+ Add Row</button>
            <input type="hidden" name="fixed_expenses" id="fixedExpensesInput">
          </div>

          <div class="mb-3">
            <label for="saving" class="form-label">Saving (₹)</label>
            <input type="number" class="form-control" name="saving" min="0"
                   value="{{ user_salary.saving|default:0 }}" required>
          </div>

          <div class="mb-3">
            <label for="emergency_percent" class="form-label">Emergency Fund (%)</label>
            <input type="range" class="form-range" min="5" max="50"
                   name="emergency_percent" value="{{ user_salary.emergency_percent }}"
                   oninput="document.getElementById('emg_val').innerText = this.value + '%'">
            <p class="text-muted">Selected: <span id="emg_val">{{ user_salary.emergency_percent }}%</span></p>
          </div>

          <div class="mb-3">
            <label for="personal_percent" class="form-label">Personal Expense (%)</label>
            <input type="range" class="form-range" min="5" max="70"
                   name="personal_percent" value="{{ user_salary.personal_percent }}"
                   oninput="document.getElementById('per_val').innerText = this.value + '%'">
            <p class="text-muted">Selected: <span id="per_val">{{ user_salary.personal_percent }}%</span></p>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Reset Day (1–28)</label>
            <div class="d-flex flex-wrap gap-2">
              {% for day in range_1_28 %}
                <input type="radio" class="btn-check" name="reset_day" id="day{{ day }}" value="{{ day }}"
                       {% if user_salary.reset_day == day %}checked{% endif %} required>
                <label class="btn btn-outline-primary btn-sm m-1" for="day{{ day }}">{{ day }}</label>
              {% endfor %}
            </div>
          </div>

          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmModal"
                  {% if not allow_edit %}disabled{% endif %}>
            Save Salary
          </button>
        </div>

        <!-- Confirm Modal -->
        <div class="modal fade" id="confirmModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Confirm Submission</h5>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to save the salary and reset day?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                <button type="submit" class="btn btn-success">Confirm & Submit</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    {% if allow_edit %}
    <script>
      var myModal = new bootstrap.Modal(document.getElementById('confirmModal'), {
        backdrop: 'static',
        keyboard: false
      });
      window.addEventListener('load', function () {
        myModal.show();
      });
    </script>
    {% endif %}
    <script>
      function addRow() {
        const row = `
          <tr>
            <td><input type="text" name="item" class="form-control" required></td>
            <td><input type="number" name="amount" class="form-control" required></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">✖</button></td>
          </tr>`;
        document.getElementById('expenseRows').insertAdjacentHTML('beforeend', row);
      }

      function removeRow(btn) {
        btn.closest('tr').remove();
      }

      // On form submit, convert to JSON
      document.querySelector("form").addEventListener("submit", function (e) {
        const items = document.querySelectorAll("input[name='item']");
        const amounts = document.querySelectorAll("input[name='amount']");
        let data = {};

        for (let i = 0; i < items.length; i++) {
          const item = items[i].value.trim();
          const amount = parseFloat(amounts[i].value);
          if (item && !isNaN(amount)) {
            data[item] = amount;
          }
        }

        document.getElementById("fixedExpensesInput").value = JSON.stringify(data);
      });
    </script>

  {% else %}
    <!-- ✅ Regular Tracker Display or Editable Panel -->
    <div class="container mt-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Salary Summary</h5>
        <p><strong>Salary:</strong> ₹{{ user_salary.salary }}</p>
        <p><strong>Fixed Expenses:</strong> ₹{{ user_salary.get_total_fixed_expense }}</p>
        <p><strong>Saving:</strong> ₹{{ user_salary.saving }}</p>
        <p><strong>Emergency:</strong> {{ user_salary.emergency_percent }}% (₹{{ user_salary.get_emergency_amount }})</p>
        <p><strong>Personal:</strong> {{ user_salary.personal_percent }}% (₹{{ user_salary.get_personal_amount }})</p>
        <p><strong>Remaining Salary:</strong> ₹{{ user_salary.remaining_salary }}</p>
        <p><strong>Reset Day:</strong> {{ user_salary.reset_day }}</p>
      </div>
    </div>
  {% endif %}
{% endif %}
{% endblock %}
