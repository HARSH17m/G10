{% extends 'expense/base.html' %}

{% block title %}EXPENSE TRACKER{% endblock %}
{% block styles %}{% endblock %}
{% block page %}EXPENSE TRACKER{% endblock %}
{% block body %}

{% if is_employed %}
  {% if show_popup %}
    <div class="container mt-4">
      <form method="post">
        {% csrf_token %}
        <div class="card p-3 shadow-sm">
          <h5 class="mb-3">Monthly Salary Input</h5>

          <div class="mb-3">
            <label for="salary" class="form-label">Salary (₹)</label>
            <input type="number" class="form-control" id="salary" name="salary"
                   value="{{ user_salary.salary|default:0 }}"
                   {% if not allow_edit %}readonly{% endif %} required>
            {% if not allow_edit and not is_first_time %}
              <small class="text-muted">Editable again on reset day.</small>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="fixed_expenses" class="form-label">Fixed Expenses (JSON)</label>
            <textarea class="form-control" id="fixed_expenses" name="fixed_expenses" rows="3"
                      placeholder='{"milk": 800, "rent": 5000}'>{{ user_salary.fixed_expenses }}</textarea>
            <small class="text-muted">Use JSON format like {"milk": 500, "rent": 6000}</small>
          </div>

          <div class="mb-3">
            <label for="saving" class="form-label">Saving (₹)</label>
            <input type="number" class="form-control" name="saving" min="0"
                   value="{{ user_salary.saving|default:0 }}" required>
          </div>

          <div class="mb-3">
            <label for="emergency_percent" class="form-label">Emergency Fund (%)</label>
            <input type="range" class="form-range" min="5" max="50"
                   name="emergency_percent" value="{{ user_salary.emergency_percent }}"
                   oninput="document.getElementById('emg_val').innerText = this.value + '%'">
            <p class="text-muted">Selected: <span id="emg_val">{{ user_salary.emergency_percent }}%</span></p>
          </div>

          <div class="mb-3">
            <label for="personal_percent" class="form-label">Personal Expense (%)</label>
            <input type="range" class="form-range" min="5" max="70"
                   name="personal_percent" value="{{ user_salary.personal_percent }}"
                   oninput="document.getElementById('per_val').innerText = this.value + '%'">
            <p class="text-muted">Selected: <span id="per_val">{{ user_salary.personal_percent }}%</span></p>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Reset Day (1–28)</label>
            <div class="d-flex flex-wrap gap-2">
              {% for day in range_1_28 %}
                <input type="radio" class="btn-check" name="reset_day" id="day{{ day }}" value="{{ day }}"
                       {% if user_salary.reset_day == day %}checked{% endif %} required>
                <label class="btn btn-outline-primary btn-sm m-1" for="day{{ day }}">{{ day }}</label>
              {% endfor %}
            </div>
          </div>

          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmModal"
                  {% if not allow_edit %}disabled{% endif %}>
            Save Salary
          </button>
        </div>

        <!-- Confirm Modal -->
        <div class="modal fade" id="confirmModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Confirm Submission</h5>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to save the salary and reset day?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                <button type="submit" class="btn btn-success">Confirm & Submit</button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      var myModal = new bootstrap.Modal(document.getElementById('confirmModal'), {
        backdrop: 'static',
        keyboard: false
      });
      window.addEventListener('load', function () {
        myModal.show();
      });
    </script>

  {% else %}
    <!-- ✅ Regular Tracker Display or Editable Panel -->
    <div class="container mt-4">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Salary Summary</h5>
        <p><strong>Salary:</strong> ₹{{ user_salary.salary }}</p>
        <p><strong>Fixed Expenses:</strong> ₹{{ user_salary.get_total_fixed_expense }}</p>
        <p><strong>Saving:</strong> ₹{{ user_salary.saving }}</p>
        <p><strong>Emergency:</strong> {{ user_salary.emergency_percent }}% (₹{{ user_salary.get_emergency_amount }})</p>
        <p><strong>Personal:</strong> {{ user_salary.personal_percent }}% (₹{{ user_salary.get_personal_amount }})</p>
        <p><strong>Remaining Salary:</strong> ₹{{ user_salary.remaining_salary }}</p>
        <p><strong>Reset Day:</strong> {{ user_salary.reset_day }}</p>
      </div>
    </div>
  {% endif %}
{% endif %}
{% endblock %}
